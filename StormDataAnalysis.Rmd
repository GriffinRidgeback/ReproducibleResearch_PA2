---
title: "Reproducible Research - Peer Assessment 2"
author: "Kevin E. D'Elia"
date: "09/18/2015"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Title
Your document should have a title that briefly summarizes your data analysis

# Synopsis
describes and summarizes your analysis in at most 10 complete sentences.

# Data Processing

```{r load_data, cache=TRUE}
stormData <- read.csv(bzfile("./data/repdata_data_StormData.csv.bz2"), stringsAsFactors = FALSE)
```


```{r descriptive_statistics}
str(stormData)
```


```{r load_dplyr}
suppressMessages(library(dplyr))
library("dplyr")
```

Describe how you came up with the excluded columns
then use dplyr to select only columns of interest

```{r select_columns}
stormData  <- stormData  %>% select(c(EVTYPE, FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP))
```

Since we are interested in events that caused fatalities and injuries, let's filter out any that didn't cause any:
This is what you want, them map this to the NWS STUFF

```{r filter_data_for_population}
populationData <-   stormData  %>% 
                    select(c(EVTYPE, FATALITIES, INJURIES)) %>% 
                    filter(FATALITIES > 0.00 & INJURIES > 0.00)
```

While we are at it, let's also create a data frame with information just about property and crop damage.

```{r filter_data_for_economics}
economicData <-   stormData  %>% 
                  select(c(EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP)) %>% 
                  filter(PROPDMG > 0.00 & CROPDMG > 0.00)

```

Can the datasets be reduced further?  Use summary to look at mean data for each group

```{r run_summary_statistics}
summary(populationData$FATALITIES)
summary(populationData$INJURIES)
summary(economicData$PROPDMG)
summary(economicData$CROPDMG)
```


```{r filter_data_based_on_summary}
populationData  <- populationData  %>% filter(FATALITIES >= 2 & INJURIES >= 20)
economicData  <- economicData  %>% filter(PROPDMG >= 50 & CROPDMG >= 50)
```


Now map names from the 48 Event Types defined by the NWS to our remaining data
```{r map_population_data}
cold  <- grepl("cold", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[cold]  <- "Cold/Wind Chill"

rain  <- grepl("rain", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[rain]  <- "Heavy Rain"

fog  <- grepl("fog", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[fog]  <- "Dense Fog"

heat  <- grepl("heat wave", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[heat]  <- "Excessive Heat"

wind  <- grepl("high wind", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[wind]  <- "High Wind"

tropical  <- grepl("tropical storm", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[tropical]  <- "Tropical Storm"

thunder  <- grepl("tstm", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[thunder]  <- "THUNDERSTORM WIND"

stream  <- grepl("urban", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[stream]  <- "Flash Flood"

fire  <- grepl("fire", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[fire]  <- "Wildfire"

hurricane  <- grepl("hurricane", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[hurricane]  <- "Hurricane (Typhoon)"

spout  <- grepl("waterspout", populationData$EVTYPE, ignore.case = T)
populationData$EVTYPE[spout]  <- "Waterspout"
```

```{r clean_factorize}
populationData$EVTYPE  <- toupper(trimws(populationData$EVTYPE))
populationData$EVTYPE  <- as.factor(populationData$EVTYPE)
```


```{r summarize_data}
y <- populationData  %>% group_by(EVTYPE) %>% summarise(fatalities = sum(FATALITIES), injuries = sum(INJURIES))
```


```{r plot_population, fig.path="./figures/"}
plot(y$fatalities, type="l", col="blue", axes=F, ann=T, xlab="Event Types", ylab="Totals", cex.lab=0.8, lwd=2, ylim=c(0, 4000))
axis(1, at=1:20, labels = F)
axis(2, las=1, cex.axis=0.8)
text(1:20, par("usr")[3] - 2, srt=45, adj=1, labels=y$EVTYPE, xpd=T, cex=0.6)
lines(y$injuries, col="green", lwd=2)
box()
```


```{r map_economic_data}
dust  <- grepl("dust", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[dust] <- "Dust Storm"

cold <- grepl("extreme cold", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[cold] <- "Extreme Cold/Wind Chill"

flash <- grepl("flash", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[flash] <- "Flash Flood"

FLOOD <- grepl("FL.*D", economicData$EVTYPE, ignore.case = F)
economicData$EVTYPE[FLOOD] <- "Flood"

freeze <- grepl("freeze", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[freeze] <- "Frost/Freeze"

gust <- grepl("gusty", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[gust] <- "High Wind"

hail <- grepl("hail", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[hail] <- "Hail"

heat <- grepl("heat", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[heat] <- "Heat"

storm <- grepl("typhoon", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[storm] <- "Tropical Storm"

rain <- grepl("rain", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[rain] <- "Heavy Rain"

hurricane <- grepl("hurricane", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[hurricane] <- "Hurricane (Typhoon)"

thunder <- grepl("thu.*s.*", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[thunder] <- "Thunderstorm Wind"

tstm <- grepl("tstm", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[tstm] <- "Thunderstorm Wind"

tropical <- grepl("tropical", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[tropical] <- "Tropical Storm"

wildfire <- grepl("wildfire", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[wildfire] <- "Wildfire"

forest <- grepl("forest", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[forest] <- "Wildfire"

winter  <- grepl("winter", economicData$EVTYPE, ignore.case = T)
economicData$EVTYPE[winter] <- "Winter Storm"
```

```{r clean_economic_data}
economicData$EVTYPE <- toupper(trimws(economicData$EVTYPE))
economicData$EVTYPE  <- as.factor(economicData$EVTYPE)

unique(economicData$PROPDMGEXP)
unique(economicData$CROPDMGEXP)

economicData <- economicData %>% filter(CROPDMGEXP != 0)
economicData$CROPDMGEXP <- toupper(economicData$CROPDMGEXP)
```


```{r calculate_property_damage_costs}
economicData$PROPDMGCOST <- 
  ifelse(economicData$PROPDMGEXP == "K", 
         economicData$PROPDMG * 1.0e+03, 
         economicData$PROPDMG * 1.0e+06)
```

```{r calculate_crop_damage_costs}
economicData$CROPDMGCOST <- 
  ifelse(economicData$CROPDMGEXP == "K", 
         economicData$CROPDMG * 1.0e+03, 
         economicData$CROPDMG * 1.0e+06)
```


```{r create_factors}
economicData$PROPDMGEXP <- as.factor(economicData$PROPDMGEXP)
economicData$CROPDMGEXP <- as.factor(economicData$CROPDMGEXP)
```

We no longer need the reduced numerical data so let's reduce the dataset a bit further.
```{r clean_up}
economicData <- economicData %>% select(-c(PROPDMG, CROPDMG))
```

Further sub-divide the economic data into property and crop damage datasets
```{r sub_divide}
propertyDamage <- economicData %>% select(EVTYPE, PROPDMGEXP, PROPDMGCOST)
cropDamage <- economicData %>% select(EVTYPE, CROPDMGEXP, CROPDMGCOST)
```
```{r calculate_costs}
A <- propertyDamage %>% group_by(EVTYPE, PROPDMGEXP) %>% summarise(costs = sum(PROPDMGCOST))
split(A, A$PROPDMGEXP)
r <- A %>% group_by(EVTYPE) %>% summarise(total_costs = sum(costs)/1.0e+06)
par(mar = rep(2, 4))
plot(r$EVTYPE, r$total_costs)

```

This link will give the definition for TSTM, i.e., thunderstorm
http://forecast.weather.gov/glossary.php?word=tstm

```{r}
knitr::kable(head(mtcars), digits = 2, align = c(rep("l", 4), rep("c", 4), rep("r", 4)))
```

describes (in words and code) how the data were loaded into R and processed for analysis. In particular, your analysis must start from the raw CSV file containing the data. You cannot do any preprocessing outside the document. If preprocessing is time-consuming you may consider using the cache = TRUE option for certain code chunks.

Does the analysis include description and justification for any data transformations? 

Your data analysis must address the following questions:

    Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

    Across the United States, which types of events have the greatest economic consequences?

Consider writing your report as if it were to be read by a government or municipal manager who might be responsible for preparing for severe weather events and will need to prioritize resources for different types of events. However, there is no need to make any specific recommendations in your report.

# Results
in which your results are presented.

You may have other sections in your analysis, but Data Processing and Results are required.

The analysis document must have at least one figure containing a plot.

Your analyis must have no more than three figures. Figures may have multiple plots in them (i.e. panel plots), but there cannot be more than three figures total.

Do the figure(s) have descriptive captions (i.e. there is a description near the figure of what is happening in the figure)?

You must show all your code for the work in your analysis document. This may make the document a bit verbose, but that is okay. In general, you should ensure that echo = TRUE for every code chunk (this is the default setting in knitr).